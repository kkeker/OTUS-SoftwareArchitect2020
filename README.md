# Homework project for the course OTUS: [Software Architect](https://otus.ru/lessons/arhitektor-po/) 2020



## Тема: Паттерны декомпозиции микросервисов.

### Домашнее задание

Паттерны декомпозиции микросервисов

Разделите ваше приложение на несколько микросервисов с учетом будущих изменений.

Попробуйте сделать несколько вариантов разбиений и попробуйте их оценить. Выберите вариант, который вы будете реализовывать.

На выходе вы должны предоставить 

1. Пользовательские сценарии
2. Общую схему взаимодействия сервисов.
3. Для каждого сервиса опишите назначение сервиса и его зону ответственности.
4. Опишите контракты взаимодействия сервисов друг с другом.

## Примечания к решению:

### 3 варианта декомпозиции микросервисов с разным разделением зон отвественности:

![var1](img/var1.png)

В этом варианте применено максимальное разделение ролей для дальнейшего масштабирования:

- reg-service - осуществляет только регистрацию пользователей, он может быть федеративным регистратором с разных источников, таких как социальные сети или собественной системы создания учетных записей. Дальнейшем, сервис может заниматься сопоставлением учетных записей из разных федеративных источников.
- micro-iam - только сервис выпуска JWT ключей, реализует цикл жизни выбранной модели авторизации, может реализовывать несколько вариантов авторизации на базе JWT, а том чистел OAuth2 или OIDC. Может использовать OTP и MFA для дополнительной проверки.
- profile-service - сервис, с бизнес-логикой управления профилем пользователя (просмотр, редактирование, удаление и т.д.), представляет из себя один из сервисов, которые находится в защищенной инвраструктуре за BFF, не принимает участие в авторизации и получает только идентификатор пользователя в HTTP Heared для реализации собственного RBAC/ABAC внутри сервиса. HTTP Header за него извлекает из JWT Body сервис BFF.
- micro-bff - сервис реализации патеррнта BFF. Позволяет предоставить имплементацию необходимой API потребителям, защитив внутренний сервисы JWT-авторизацией в парадигме микросервисов. Так же, извлекает из JWT поле sub и превращает его в HTTP Hearder для передачи в сервисы за ним для целей аутентификации. Осуществляет роутинг и перезапись путей API для составления единой карты URL.

![var2](img/var2.png)

В данном варинте нет паттенра BFF, подразуменвается что нет необходимости предоставлять разные имплементации API разным потребителем. Могут быть только задачи перезаписи маршрутов и авторизации. Тогда с этой задачей справится API Gateway или Ingress в системе развертывания Kubernetes (как в примере).

Остальные роли сервисов остаются без изменения как варинте 1.

![var3](img/var3.png)

В данном варианте, как и в варианте 2, нет паттерна BFF, его роль по прежнему выполняет сервис API Gateway или Ingress в Kubernetes.

Так же, в этом варианте упрощена схема и смешаны домены авторизации/аутентификации и выпуска ключей. Для этого есть сервис user-service. Данный вариант подходит для начала развития приложения и больше похож на этап развития монолитного приложения.

### Диаграмма последовательности запросов для варианта 1:

![sequence](img/sequence.png)

### OpenAPI v3 IDLs варианта 1:

- [micro-iam](idl/micro-iam.yml)
- [profile-service](idl/profile-servoce.yml)
- [reg-service](idl/reg-service.yml)

### Microservices Canvas варианта 1:

![micro-bff-canvas](img/micro-bff-canvas.png)

![micro-iam-canvas](img/micro-iam-canvas.png)

![profile-service-canvas](img/profile-service-canvas.png)

![reg-service-canvas](img/reg-service-canvas.png)

Применялся инструмент https://solusoftsl.github.io/microservices-design-canvas-editor/ 

Возможные аналоги:

- https://www.visual-paradigm.com/features/business-model-canvas-tool/
- https://warren2lynch.medium.com/business-model-canvas-learn-by-examples-with-free-online-software-474a872a9bcd
- https://github.com/cer/microservice-canvas/blob/master/order-service-example-canvas.adoc

### [Пользовательские истории и Kanban-проект варианта 1](https://github.com/kkeker/OTUS-SoftwareArchitect2020/projects/1)

